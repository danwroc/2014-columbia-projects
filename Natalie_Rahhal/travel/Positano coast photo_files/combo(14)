YUI.add("hermes-template-photo-charm-contexts",function(e,t){var n=e.Template.Handlebars.revive(function(e,t,n,r,i){return this.compilerInfo=[4,">= 1.0.0"],n=this.merge(n,e.helpers),i=i||{},'<div class="context-views"></div>\n<div class="photostream-context-view"></div>'}),r={};e.Array.each([],function(t){var n=e.Template.get("hermes/"+t);n&&(r[t]=n)}),e.Template.register("hermes/photo-charm-contexts",function(e){return n(e,{partials:r})})},"@VERSION@",{requires:["template-base","handlebars-base"]});
YUI.add("photo-charm-contexts-view",function(e){e.namespace("Views")[this.name]=e.Base.create("photo-charm-contexts-view",e.FlickrView,[],{initializer:function(t){return this.photoId=t.photoId,this.context=e.clone(t.context,!0),this.get("container").html===""&&this.setContainerHTML(""),this},loadState:function(){var t=this;return e.batch(t.appContext.getModel("photo-models",this.photoId),t.appContext.getModel("photo-contexts-models",this.photoId)).then(function(e){t.set("photo",e[0]),t.set("photo-contexts",e[1])})},buildContainer:function(){var e;return e=this.templates("photo-charm-contexts")(),this.setContainerHTML(e),this},activate:function(){var e=this,t=[],n=this.get("photo-contexts"),r;return t=n.registry.getContextsNotOfType(n.id,"photostream-models"),t.length>9&&(t.length=9),e.deferContextLoading(t,function(t){return e.activateContext(t)}),r=n.registry.getContextsOfType(n.id,"photostream-models"),r.length>0&&e.activateContext(r[0],"photostream-view"),this.registerEventHandler(n.on("valuesChanged",e.handleContextChanges.bind(e))),this},handleContextChanges:function(e){var t=this.get("container"),n=e.contexts&&e.contexts.prevVal,r=e.contexts&&e.contexts.newVal&&e.contexts.newVal.getList(),i=this.get("photo-contexts"),s,o,u;n&&n.length>0&&(n.length>r.length?(s=this.diffContextLists(r,n).removed[0].id,t.one('.context-view[data-context-id="'+s+'"]')&&t.one('.context-view[data-context-id="'+s+'"]').remove()):(u=i.registry.getContextsNotOfType(i.id,"photostream-models"),u.length<=9&&(o=this.diffContextLists(r,n).added[1],this.activateContext(o))))},diffContextLists:function(t,n){var r={added:[],removed:[]};return e.Array.each(t,function(t){e.Array.indexOf(n,t)===-1&&r.added.push(t)}),e.Array.each(n,function(n){e.Array.indexOf(t,n)===-1&&r.removed.push(n)}),r},deferContextLoading:function(t,n){var r=this,i=4;t.length<i?e.Array.each(t,function(e){n.call(r,e)}):e.batch.apply(this,t.slice(0,i).map(function(e){return n.call(r,e)})).then(function(){r.isActiveAndInDOM()&&r.deferContextLoading(t.slice(i),n)})},activateContext:function(t,n){var r=this,i=t.registry.name==="photostream-models",s=e.URLHelper.parseContextURL(t.getValue("urlSuffix"),r.get("photo"),this.appContext),o={},u=24,a=8,f=16,l=4;return s&&s.params&&(o=s.params),o=e.merge(o,{id:t.id}),this.photosLoadedInContexts=[],r.appContext.getView("context-view",{nsid:r.nsid,photoId:r.photoId,context:{modelName:t.registry.name,params:o},perPage:i?u:a,displayNum:i?f:l,usePageFetcher:this.appContext.flipper.isFlipped("context-slider")||!i,numPrev:0,numNext:f}).then(function(t){return r.subviews[n||e.guid("context-view")]=t,t.registerEventHandler(t.on("flickr:photo-charm-contexts-view--track-context-photos",function(e){var n=e.details[0],s,o=[],u=i?f:l,a=r.photosLoadedInContexts.length+0;if(!n)return[];s=n.pop();while(s&&r.photosLoadedInContexts.length<a+u)r.photosLoadedInContexts.indexOf(s)>-1?o.push(s):r.photosLoadedInContexts.push(s),s=n.pop();s&&r.photosLoadedInContexts.length>=a+u&&o.push.apply(o,[s].concat(n)),t.fire("flickr:photo-charm-contexts-view--duplicate-context-photos",o)})),t.initialize().then(function(){n==="photostream-view"?r.get("container").one(".photostream-context-view")&&r.get("container").one(".photostream-context-view").append(t.get("container")):r.get("container").one(".context-views")&&r.get("container").one(".context-views").append(t.get("container"))})}).then(null,function(e){console.error(String(e),e)})}})},"@VERSION@",{requires:["flickr-view","hermes-template-photo-charm-contexts","url-helper"],optional:[]});
